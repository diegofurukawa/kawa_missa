version: '3.8'

services:
  # Next.js Application Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        EXTERNAL_PORT: ${EXTERNAL_PORT:-3115}
        INTERNAL_PORT: ${INTERNAL_PORT:-3115}
    image: kawa_missa:latest
    pull_policy: never
    container_name: kawa_missa
    restart: unless-stopped
    ports:
      - "${EXTERNAL_PORT:-3115}:${INTERNAL_PORT:-3115}"
    networks:
      furukawatech-network:
        ipv4_address: 172.30.0.55
    # All environment variables for Portainer
    # These will be provided via Portainer Environment Variables section
    environment:
      # === Docker Build ===
      DOCKER_BUILD: "true"

      # === Network & Server ===
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${INTERNAL_PORT:-3115}
      EXTERNAL_PORT: ${EXTERNAL_PORT:-3115}
      HOST: ${HOST:-0.0.0.0}
      HOSTNAME: ${HOSTNAME:-0.0.0.0}
      
      # === Database ===
      DATABASE_URL: ${DATABASE_URL}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      
      # === Authentication & Security ===
      AUTH_SECRET: ${AUTH_SECRET}
      AUTH_TRUST_HOST: "true"
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-30d}

      # === Application URLs ===
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL}
      NEXT_PUBLIC_DEFAULT_HOSTS: ${NEXT_PUBLIC_DEFAULT_HOSTS}

    # healthcheck:
    #   test: ["CMD-SHELL", "curl -f http://localhost:${INTERNAL_PORT:-3115}/api/health || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s
    # volumes:
    #   - app_cache:/app/.next/cache


# Named Volumes
# volumes:
#   postgres_data:
#     driver: local
#     name: furukawatech_postgres_data
#   app_cache:
#     driver: local
#     name: furukawatech_app_cache

# Custom Network
networks:
  furukawatech-network:
    external: true
