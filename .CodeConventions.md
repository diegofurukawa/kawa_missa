# Code Conventions

## 1. General Principles
- **Clarity over Cleverness**: Write readable, maintainable code.
- **Strict TypeScript**: Strict mode enabled. Avoid `any` types (some still exist - improvement area).
- **Functional**: Prefer functional components and hooks.
- **Server-First**: Use Server Components by default, Client Components only when needed.

## 2. Next.js & React
- Use **App Router** (`app/` directory).
- Use **Server Components** by default. Use `'use client'` only when interaction/state is needed.
- **Naming**:
    - Components: PascalCase (e.g., `UserCard.tsx`).
    - Utilities: camelCase (e.g., `formatDate.ts`).
    - Folders: kebab-case (e.g., `user-profile`).

## 3. Folder Structure
- `app/`: Routes and pages (Server Components by default).
- `app/ui/`: UI components organized by feature:
    - `app/ui/dashboard/`: Dashboard-specific components (sidenav, header, carousel, etc.)
    - `app/ui/masses/`: Mass-related forms and components
    - `app/ui/config/`: Configuration forms
    - `app/ui/organization/`: Organization forms
    - `app/ui/login/`: Login components
    - `app/ui/button.tsx`, `app/ui/tag.tsx`, etc.: Shared UI primitives
- `lib/`: 
    - `lib/actions.ts`: All server actions (with `'use server'` directive)
    - `lib/data.ts`: Data fetching functions
    - `lib/definitions.ts`: Type definitions and Zod schemas
    - `lib/prisma.ts`: Prisma client singleton instance
- `app/api/`: API routes (e.g., NextAuth routes)
- `prisma/`: Schema and migrations
- `types/`: Global or shared type definitions
- `auth.ts` & `auth.config.ts`: NextAuth configuration

## 4. Server Actions
- All server actions are centralized in `lib/actions.ts` with `'use server'` directive at the top.
- **Validation**: Use Zod schemas for input validation (e.g., `MassSchema`, `TenantSchema`).
- **Return Pattern**: 
    ```typescript
    {
        message?: string;
        errors?: Record<string, string[]>;
        success?: boolean;
    }
    ```
- **Error Handling**:
    - Handle Prisma errors (`Prisma.PrismaClientKnownRequestError`) with specific error codes (e.g., `P2002` for unique constraint violations).
    - Return user-friendly error messages in Portuguese.
    - Log errors with `console.error` for debugging.
- **After Operations**: Use `revalidatePath()` to invalidate cache and `redirect()` for navigation after successful mutations.
- **Authentication**: Check session with `await auth()` from `@/auth` before operations that require authentication.

## 5. Client Components
- Use `'use client'` directive at the top of the file when:
    - Component needs interactivity (onClick, onChange, etc.)
    - Component uses React hooks (useState, useEffect, etc.)
    - Component uses browser APIs
    - Component needs to access client-side context (e.g., SessionProvider)
- **Forms**: Use `useActionState` from React for server actions:
    ```typescript
    const [state, dispatch, isPending] = useActionState(serverAction, undefined);
    ```
- **Toast Notifications**: Use `toast` from `sonner`:
    - `toast.error(message)` for errors
    - `toast.success(message)` for success
    - Handle in `useEffect` when state changes

## 6. Forms & User Input
- Forms use Server Actions via `useActionState` hook.
- Form data is passed as `FormData` to server actions.
- Client-side validation can be added, but server-side validation with Zod is mandatory.
- Dynamic form fields (e.g., multiple participants per role) use prefixed keys:
    - Format: `role_${roleName}` for participants
    - Format: `cron_${index}` for cron expressions
    - Format: `role_${index}` and `qty_${index}` for role configurations
- Date and time inputs are combined into ISO datetime string before submission.

## 7. Styling (Tailwind CSS)
- Use utility classes directly.
- Use `clsx` for conditional class names (e.g., `clsx('base-class', { 'active-class': isActive })`).
- Avoid `@apply` in CSS files unless creating a reusable atomic class is strictly necessary.
- Mobile-first approach.
- **Custom Colors**:
    - Primary: `#6d7749` (green) - used for primary buttons, active states, brand elements
    - Secondary: `#6546b8` (purple) - used for secondary actions
    - Background: `#f6f5f8` (light gray) - used for sidebar and light backgrounds
- Use Tailwind's color utilities with custom values when needed: `bg-[#6d7749]`, `hover:bg-[#5d6541]`

## 8. Database (Prisma v7)
- Schema definitions in `prisma/schema.prisma`.
- Use strictly typed queries.
- **Client Setup**: 
    - Database client instance is a singleton in `lib/prisma.ts`.
    - Uses Prisma adapter pattern with `@prisma/adapter-pg` for PostgreSQL.
    - Connection pooling with `pg.Pool` for better performance.
    - Singleton pattern prevents multiple instances in development.
- **Transactions**: Use `prisma.$transaction()` for multi-step operations (e.g., creating tenant + user).
- **Error Handling**: Check for `Prisma.PrismaClientKnownRequestError` with specific error codes.

## 9. Authentication (NextAuth v5)
- Using NextAuth v5 (beta) with credentials provider.
- Configuration split between:
    - `auth.config.ts`: Auth configuration (callbacks, pages, etc.)
    - `auth.ts`: NextAuth instance with providers and callbacks
- **Session**: Access session with `await auth()` in Server Components and server actions.
- **Client Session**: Use `useSession()` from `next-auth/react` in Client Components (wrapped in `SessionProvider`).
- **Middleware**: Configured in `middleware.ts` to protect routes.
- **JWT Callbacks**: Extend token with `id`, `role`, and `tenantId` for easy access in components.

## 10. Feedback (Sonner)
- Use `sonner` for all user-facing notifications (success, error, info).
- Configure the `Toaster` component at the root layout (`app/layout.tsx`).
- **Usage in Client Components**:
    ```typescript
    import { toast } from 'sonner';
    
    useEffect(() => {
        if (state?.message) {
            toast.error(state.message);
        }
    }, [state?.message]);
    ```
- Use Portuguese messages for user-facing notifications.

## 11. Imports
- **Absolute imports** (preferred for):
    - `@/lib/*` - Server actions, data fetching, utilities
    - `@/auth` - Authentication
    - `@/app/ui/*` - UI components (when importing from pages)
- **Relative imports** (acceptable for):
    - Same directory or nearby components (e.g., `../button`, `./tag-input`)
    - When importing from sibling files in the same feature folder
- **Examples**:
    ```typescript
    import { createMass } from '@/lib/actions';
    import { auth } from '@/auth';
    import { Button } from '../button';
    import { TagInput } from '../tag-input';
    ```

## 12. TypeScript
- Strict mode enabled in `tsconfig.json`.
- **Type Definitions**:
    - Shared types and Zod schemas in `lib/definitions.ts`
    - Inline types for component-specific props
    - Extend NextAuth types in `types/next-auth.d.ts`
- **Improvement Area**: Some `any` types still exist (e.g., `tenant: any` in form props). These should be replaced with proper types.

## 13. Data Fetching
- Data fetching functions in `lib/data.ts`.
- Functions are async and return typed data.
- Use Prisma queries with proper type inference.
- Handle errors gracefully and return null/empty arrays when appropriate.

## 14. Error Handling Patterns
- **Server Actions**: Return error objects with `message` field, handle Prisma errors specifically.
- **Client Components**: Use `useEffect` to watch for error states and show toast notifications.
- **User Messages**: All error messages should be in Portuguese and user-friendly.
- **Logging**: Use `console.error` for debugging server-side errors (avoid exposing sensitive info to clients).
